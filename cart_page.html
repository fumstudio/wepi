<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        
        
  <link rel="stylesheet" href="style.css
    ">
   
      <link rel="stylesheet" href="css/catalog.css
    ">    
    
   <link rel= "Shortcut icon" type="x-icon" href= "https://i.postimg.cc/XqrhcVpD/20240702-095704.png "> 
<title>Your cart</title>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9RJSDSSVMM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9RJSDSSVMM');
</script>
  
  <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MNW5B4W9');</script>
<!-- End Google Tag Manager -->
 
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <script>
        $(function(){
            $("#navbar").load("navbar.html");
        });
    </script>

        <script>
        $(function(){
            $("#footer").load("footer.html");
        });
    </script>        


    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;

        }

        
/* General styles for the cart item */
.cart-item {
    display: flex;
    flex-direction: column;
    border: 1px solid #ddd;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
    background-color: #f9f9f9;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Container for the cart item content */
.cart-item-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 15px;
}

/* Styles for the image link */
.image-link-button2 {
    text-decoration: none;
    color: inherit;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Styles for the cart images container */
.cart-images {
    display: flex;
    gap: 10px;
}

/* Styles for the cart item images */
.cart-item-image {
    width: auto;
    height: 70px;
    object-fit: cover;
    border-radius: 4px;

}

/* Styles for the delete button */
.delete-button {
    background-color: #ff4d4d;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
}

.delete-button:hover {
    background-color: #ff1a1a;
}

/* Styles for the item price */
.item-price {
    font-size: 14px;
    font-weight: bold;
    color: #333;
    margin: 10px 0;
}

/* Styles for the customized link buttons */
.image-link-buttoncustom,
.image-link-button {
    text-decoration: none;
    color: #FFFFFF;
    background-color:  #FBD64C;
    padding: 8px 12px;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin: 5px 0;
}


/* Styles for the button container */
.button-container {
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Styles for the quantity controls */
.quantity-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    background-color: #f1f1f1;
    padding: 5px 10px;
    border-radius: 4px;

}
.cart-item h2 {
    font-size: 1.2em;
    margin: 0;
    padding: 10px;
    margin-bottom: 0px;
        color: #2E2F33;
        
}

.quantity-controls span {
    cursor: pointer;
    font-size: 16px;
    color: #333;
}

.quantity-controls span:hover {
    color: #007bff;
}

/* Styles for the item quantity */
.item-quantity {
    font-weight: bold;
    color: #333;
}
.item-price {
  color: #E58A52;
          padding: 1px 10px;
        font-weight: bold;   

}
        #totalPriceContainer {
            margin-top: 20px;
            text-align: center;
        }
        #clearCartButton, #payNowButton {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color:  #2E2F33;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1.2em;
        }
        #clearCartButton {
display: none;
        }

        #cartAlert {
            display: none;
            background-color: #28a745;
            color: white;
            padding: 10px;
            position: absolute;
            top: 10px;
            right: 10px;
            border-radius: 5px;
        }
       .original-price {
    text-decoration: line-through;
    color: gray;
    margin-right: 10px;
}

.pay-price {
    color: green;
    font-weight: bold;
}
/* General styles */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: 'Arial', sans-serif;
}

/* Bottom Navbar container display: flex;*/
.bottomNavbar {
  justify-content: space-between;
  align-items: center;
  background-color: #f5f5f5;
  padding: 15px 30px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  border-radius: 10px;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  max-height: 1000%; /* Set a max height for the navbar */
  overflow-y: auto;  /* Enable vertical scrolling if content overflows */
  scroll-behavior: smooth; /* Optional: smooth scrolling */
 
}
/* Total Price section */
.totalPrice {
  font-size: 16px;
  color: #333;
}

.price {
  font-weight: bold;
  color: #2d8b1d;  /* Green for price */
}


.discount {
  margin-top: 5px;
  font-size: 14px;
  color: #e74c3c;  /* Red for discount */
  font-style: italic;
}

/* Shipping fee section */
.shipping-fee {
  font-size: 14px;
  color: #555;
  margin-top: 5px;
}

/* Total Amount section */
.totalAmountToPay {
  font-size: 18px;
  color: #333;
  font-weight: bold;
}

/* PayPal button container */
#paypal-button-container {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  width: 100%;
}

/* Responsive design for small screens */
@media screen and (max-width: 768px) {
  .bottomNavbar {
    flex-direction: column;
    align-items: flex-start;
    padding: 10px;
  }

  .totalPrice {
    margin-bottom: 10px;
  }

  .totalAmountToPay {
    margin-top: 10px;
  }

  #paypal-button-container {
    margin-top: 10px;
    width: 100%;
  }
}
    </style>
<style>
        /* Container for the hidden content */
        .hidden-content {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #f4f4f4;
            border: 1px solid #ccc;

            width :400%;
            margin-bottom: 100px;

        }

@media screen and (max-width: 
488px) {
          .hidden-content {

            width :100%;
  }


}  
        /* Style for the toggle button */
        .toggle-btn {
          margin-top: 100px;
            display: inline-block;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            margin-left: 200px;
margin-top: -400%;
        }
.modal.hidden {
  display: none;
}
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
}
.modal-content {
  background-color: white;
  padding: 20px;
  border-radius: 5px;
      font-weight: bold;
}

.green-btn {
  background-color: green;
  color: white;
  border: none;
    padding: 10px 20px;
  margin: 10px;
  cursor: pointer;
}

.red-btn {
  background-color: red;
  color: white;
  border: none;
    padding: 10px 20px;
  margin: 10px;
  cursor: pointer;
}

.main-nav {

top :0;
 }  
 .empty-cart {
    display: flex;
    justify-content: center;   /* Centers the text horizontally */
    align-items: center;       /* Centers the text vertically */
    height: 100vh;             /* Makes the container take full viewport height */
    font-size: 20px;
 }  

#cartContainer{
  
  margin-bottom: 100%;
}
    </style>
</head>
<script src="https://www.paypal.com/sdk/js?client-id=AVdMF1TEsNUQfjkw9ws2tP40ad63FoxcLbN9hT11WnvBPXRU4fCWruU7AGFDcSuqY-MUnWtVLjhkY90W&currency=USD"></script>
<body>
<div class="container2">
 <div class="menu-btn">
    <i class="fas fa-bars fa-2x"></i>
  </div>

    <!-- Nav -->
 <nav class="main-nav">
          <h1 alt="Microsoft" class="logo">
<i class="fas fa-arrow-left back-button" onclick="goBack()"></i>

<script>
function goBack() {
    window.history.back();
}
</script>
My cart</h1>
        <div id="navbar"></div>
</nav>

</div>
<br><br><br>
  <div id="cartContainer"></div>


<button id="clearCartButton" class="clear-cart-button"><i class="fas fa-trash"></i></button>
<div id="cartAlert">Item has been added to your cart!</div>

<div class="bottomNavbar">
  

    <div class="totalPrice">
        Total price: <span class="price" data-price="0">ZAR 0</span>
        <p class="discount"></p>    <a href="Order_confirmation.html"><button class="toggle-btn">Checkout   <span id="totalItemCount">0</span></button></a>
  <!-- This is where the discount text will appear -->
       <!-- Hidden content -->
    <div class="hidden-content">


  
   <div class="shipping-fee"></div>     

<div class="totalAmountToPay"></div>    
    <div id="paypal-button-container"></div>     </div><!-- PayPal button will be added here -->
</div>
</div></div>
<div id="clearCartModal" class="modal hidden">
  <div class="modal-content">
    <p>Do you really want to clear the cart? </p>
    <button id="confirmClearCart" class="confirm-btn green-btn">Yes</button>
    <button id="cancelClearCart" class="cancel-btn red-btn">No</button>
  </div>
</div>
<div id="confirmationModal" class="modal hidden">
  <div class="modal-content">
    <p>Do you really want to delete this item? </p>
    <button id="confirmDelete" class="confirm-btn green-btn">Yes</button>
    <button id="cancelDelete" class="cancel-btn red-btn">No</button>
  </div>
</div>

</div>  
</div>  


</div>  

 <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MNW5B4W9"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    
   
<script src="https://www.paypal.com/sdk/js?client-id=AVdMF1TEsNUQfjkw9ws2tP40ad63FoxcLbN9hT11WnvBPXRU4fCWruU7AGFDcSuqY-MUnWtVLjhkY90W&currency=USD"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref as dbRef, get, set, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBDrzrgLslaJvnXbo1e90irCEtdcm9ZsCU",
        authDomain: "logins-13661.firebaseapp.com",
        databaseURL: "https://logins-13661-default-rtdb.firebaseio.com",
        projectId: "logins-13661",
        storageBucket: "logins-13661.appspot.com",
        messagingSenderId: "451535349483",
        appId: "1:451535349483:web:d3c9867fd2bffbbdca40ae",
        measurementId: "G-DWP16WX2H7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Conversion rates from ZAR to other currencies
    const conversionRates = {
        'ZAR': 1, // South African Rand (base currency)
        'USD': 0.053, // Example rate: 1 ZAR = 0.053 USD
        'EUR': 0.048 // Example rate: 1 ZAR = 0.048 EUR
    };

    // Store the user's selected currency (for demo purposes, let's assume it's stored in a variable)
let storedCurrency = 'ZAR'; // Default currency

// Function to retrieve user's currency preference from Firebase
async function getCurrencyFromFirebase() {
    const userId = auth.currentUser ? auth.currentUser.uid : null;

    if (userId) {
        const userRef = dbRef(db, `users/${userId}/selectedCurrency`);
        
        try {
            const snapshot = await get(userRef);
            if (snapshot.exists()) {
                storedCurrency = snapshot.val() || 'ZAR';  // Default to 'ZAR' if no currency is set
                console.log(`User's currency preference: ${storedCurrency}`);
                
                // Store the currency in localStorage to use globally
                localStorage.setItem('selectedCurrency', storedCurrency);
            } else {
                console.log('No currency preference found for the user.');
            }
        } catch (error) {
            console.error('Error fetching currency preference:', error);
            storedCurrency = 'ZAR';  // Fallback to ZAR if there's an error
        }
    }
}

// Call the function to get the currency from Firebase before using it
getCurrencyFromFirebase().then(() => {
    // Now you can use the 'storedCurrency' variable in your app after fetching it from Firebase
    console.log(`Currency after fetching from Firebase: ${storedCurrency}`);
});
    document.addEventListener('DOMContentLoaded', () => {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadCart(user.uid);
            } else {
                document.getElementById('cartContainer').innerHTML = '<div class="empty-cart">Please log in to view your cart.</div>';
            }
        });






// Function to check the cart and hide the clear button if empty
async function checkCart() {
    const user = auth.currentUser;
    if (user) {
        try {
            const userId = user.uid;
            const cartRef = dbRef(db, 'carts/' + userId);

            // Get the current cart data from the database
            const snapshot = await get(cartRef);
            if (snapshot.exists()) {
                const cart = snapshot.val().cart;

                // If the cart is empty, hide the "Clear Cart" button
                if (cart && cart.length === 0) {
                    document.getElementById('clearCartButton').style.display = 'none';
                } else {
                    document.getElementById('clearCartButton').style.display = 'inline-block';
                }
            }
        } catch (error) {
            console.error("Error checking cart:", error);
        }
    }
}

document.getElementById('clearCartButton').addEventListener('click', () => {
    // Show the confirmation modal
    document.getElementById('clearCartModal').classList.remove('hidden');
});

document.getElementById('confirmClearCart').addEventListener('click', async () => {
    const user = auth.currentUser;
    if (user) {
        try {
            const userId = user.uid;
            // Clear the user's cart in the database
            await set(dbRef(db, 'carts/' + userId), { cart: [] });
            
            // Update the UI to show that the cart is empty
            document.getElementById('cartContainer').innerHTML = '<div class="empty-cart">Your cart is empty.</div>';
        } catch (error) {
            console.error("Error clearing cart:", error);
        }
    }

    // Hide the modal after confirmation
    document.getElementById('clearCartModal').classList.add('hidden');
});

document.getElementById('cancelClearCart').addEventListener('click', () => {
    // Just hide the modal without clearing the cart
    document.getElementById('clearCartModal').classList.add('hidden');
});






        ;
    });
const clearCartButton = document.getElementById('clearCartButton');
const clearCartModal = document.getElementById('clearCartModal');
const confirmClearCartButton = document.getElementById('confirmClearCart');
const cancelClearCartButton = document.getElementById('cancelClearCart');

    // Load cart from Firebase
    async function loadCart(userId) {
        const cartRef = dbRef(db, 'carts/' + userId);
        
     await getCurrencyFromFirebase();  // Make sure to fetch the currency before proceeding 
              
        const snapshot = await get(cartRef);

        if (snapshot.exists() && snapshot.val().cart) {
            const cartItems = snapshot.val().cart;
            cartItems.forEach(item => {
                if (!item.quantity) {
                    item.quantity = 1;  // Set default quantity if not defined
                }
            });
            displayCart(cartItems);
        } else {
            document.getElementById('cartContainer').innerHTML = '<div class="empty-cart">Your cart is empty. <i class="fas fa-shopping-cart"></i></div>';
        }
    }

function displayCart(cartItems) {
    const cartContainer = document.getElementById('cartContainer');
    cartContainer.innerHTML = '';

    if (cartItems.length === 0) {
        cartContainer.innerHTML = '<div class="empty-cart">Your cart is empty.</div>';
        return;
    }

// Define a function to get the total item count from the cart
function getTotalItemCount(cartItems) {
    return cartItems.reduce((total, item) => {
        return total + (item.quantity || 1); // Add the quantity of each item, defaulting to 1 if not defined
    }, 0);
}

// Update the total item count in the UI
function updateTotalItemCount(cartItems) {
    const totalItemCount = getTotalItemCount(cartItems);
    const itemCountElement = document.getElementById('totalItemCount');
    if (itemCountElement) {
        itemCountElement.innerText = `(${totalItemCount})`;
    }
}

    cartItems.forEach((item, itemIndex) => {
        if (typeof item.quantity === 'undefined') {
            item.quantity = 1;  // Default quantity if not set
        }

        const designs = Array.isArray(item.designs) ? item.designs : [];
        const priceInSelectedCurrency = convertPrice(item.cost, storedCurrency);

        const itemDiv = document.createElement('div');
        itemDiv.classList.add('cart-item');

        itemDiv.innerHTML = 

            `
 
            
            <a href="${item.catalogUrl}" target="_blank" class="image-link-button2">
                <h2>${item.title}</h2>
                              <div class="cart-item-container"> 
                           
                <div class="cart-images">
                    ${designs.map(design => 
                        `<img src="${design.itemImage}" alt="Design Image" class="cart-item-image">`).join('')}
                </div>
            </a>

  <button class="image-link-button delete-button" data-index="${itemIndex}"><i class="fas fa-trash"></i></button> 
               </div>                  <div class="button-container">
    ${item.shareableLink ? `<a href="${item.shareableLink}" class="image-link-buttoncustom" target="_blank">Customized<i class="fa fa-paint-brush"></i></a>` : ''}
    <div class="quantity-controls">
        <span class="decrease-quantity-btn" data-index="${itemIndex}">-</span>
        <span class="item-quantity" data-index="${itemIndex}">${item.quantity}</span>
        <span class="increase-quantity-btn" data-index="${itemIndex}">+</span>
    </div>
</div>                                      <p class="item-price"> ${storedCurrency} ${priceInSelectedCurrency}</p>      
     


                               
</div>`;


        itemDiv.querySelector('.decrease-quantity-btn').addEventListener('click', () => {
            updateQuantity(itemIndex, -1);
        });

        itemDiv.querySelector('.increase-quantity-btn').addEventListener('click', () => {
            updateQuantity(itemIndex, 1);
        });

        itemDiv.querySelector('.delete-button').addEventListener('click', () => {
            showConfirmationModal(itemIndex);
        });

        cartContainer.appendChild(itemDiv);
    });

updateTotalPrice(cartItems);
    updateTotalItemCount(cartItems); // Update the total item count
}

    async function updateQuantity(itemIndex, change) {
        const user = auth.currentUser;
        if (user) {
            const userId = user.uid;
            const cartRef = dbRef(db, 'carts/' + userId);

            const snapshot = await get(cartRef);
            if (snapshot.exists()) {
                const cartItems = snapshot.val().cart || [];
                const item = cartItems[itemIndex];

                if (item) {
                    let currentQuantity = item.quantity || 1;
                    currentQuantity += change;

                    if (currentQuantity < 1) {
                        currentQuantity = 1; // Prevent quantity from being less than 1
                    }

                    item.quantity = currentQuantity;

                    await set(cartRef, { cart: cartItems });

                    displayCart(cartItems);  // Re-render the cart with updated items
                }
            }
        }
    }


// Show the confirmation modal
function showConfirmationModal(itemIndex) {
    const confirmationModal = document.getElementById('confirmationModal');
    confirmationModal.classList.remove('hidden');  // Show the modal

    const confirmButton = document.getElementById('confirmDelete');
    const cancelButton = document.getElementById('cancelDelete');

    // If the user clicks "Yes", delete the item
    confirmButton.onclick = () => {
        deleteItem(itemIndex);
        confirmationModal.classList.add('hidden');  // Hide the modal after confirming
    };

    // If the user clicks "No", hide the modal without doing anything
    cancelButton.onclick = () => {
        confirmationModal.classList.add('hidden');  // Hide the modal
    };
}


// Delete item from cart
    async function deleteItem(itemIndex) {
        const user = auth.currentUser;
        if (user) {
            const userId = user.uid;
            const cartRef = dbRef(db, 'carts/' + userId);

            const snapshot = await get(cartRef);
            if (snapshot.exists()) {
                const cartItems = snapshot.val().cart || [];
                cartItems.splice(itemIndex, 1);  // Remove item at specified index
                await set(cartRef, { cart: cartItems });  // Update cart in Firebase
                displayCart(cartItems);  // Re-render cart with updated items
                showCartAlert();  // Show the success alert
            }
        }
    }
    // Show alert when item is deleted
    function showCartAlert() {
        const alert = document.getElementById('cartAlert');
        alert.style.display = 'block';
        setTimeout(() => {
            alert.style.display = 'none';
        }, 2000);
    }


    function generateCartId() {
        return 'cart_' + Math.random().toString(36).substr(2, 9); // Generates a random string like "cart_x8jdy3p94"
    }

    // Generate timestamp (date and time)
    function generateTimestamp() {
        const date = new Date();
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');

        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
    }


// Conversion function
function convertPrice(price, currency) {
    if (currency === 'USD') {
        return (price / conversionRates['ZAR'] * conversionRates['USD']).toFixed(2); // Convert ZAR to USD
    } else if (currency === 'EUR') {
        return (price / conversionRates['ZAR'] * conversionRates['EUR']).toFixed(2); // Convert ZAR to EUR
    } else {
        return price.toFixed(2); // Return price as is for ZAR
    }
}

function updateTotalPrice(cartItems) {
    // Step 1: Calculate the total price from cart items (without shipping)
    const totalPriceZAR = cartItems.reduce((total, item) => {
        return total + (item.cost * item.quantity); // Sum up item costs with quantities
    }, 0);

    const shippingFeeZAR = 0; // Shipping fee of ZAR 10
    let shippingFeeToApply = shippingFeeZAR; // Default shipping fee
    let totalWithShippingZAR = totalPriceZAR ; // Start with total including shipping fee
    let discounted = false;
    let discountAmountZAR = 0;
    let discountPriceZAR = totalWithShippingZAR; // Initialize discountPriceZAR with the total price (including shipping)

    // Step 2: Check if the total price qualifies for free shipping (ZAR > 500)
    if (totalPriceZAR > 500) {
        shippingFeeToApply = 0; // Remove shipping fee if total > ZAR 500
    }

    // Step 3: Apply discounts based on total price (including shipping if applicable)
    const totalWithPossibleShipping = totalPriceZAR + shippingFeeToApply;
    if (totalWithPossibleShipping > 1000) {
        // Apply 10% discount if total (with shipping) exceeds ZAR 1000
        discounted = true;
        discountPriceZAR = totalWithPossibleShipping * 0.9; // Apply 10% discount
        discountAmountZAR = totalWithPossibleShipping - discountPriceZAR; // Calculate discount amount
    }
    else if (totalWithPossibleShipping > 400) {
        // Apply 5% discount if total (with shipping) exceeds ZAR 400
        discounted = true;
        discountPriceZAR = totalWithPossibleShipping * 0.95; // Apply 5% discount
        discountAmountZAR = totalWithPossibleShipping - discountPriceZAR; // Calculate discount amount
    }

    // Step 4: Convert the values (prices, shipping fee, and discount) into the selected currency
    const totalPriceConverted = convertPrice(totalPriceZAR, storedCurrency);
    const shippingFeeConverted = convertPrice(shippingFeeToApply, storedCurrency); // Convert the shipping fee
    const discountPriceConverted = convertPrice(discountPriceZAR, storedCurrency);
    const discountAmountConverted = convertPrice(discountAmountZAR, storedCurrency); // Convert discount amount to currency

    // Step 5: Update the HTML with calculated values
    const totalPriceElement = document.querySelector('.totalPrice .price');
    const discountElement = document.querySelector('.totalPrice .discount'); // Element to show discount amount
    const shippingElement = document.querySelector('.shipping-fee'); // Element to show shipping fee
    const totalAmountElement = document.querySelector('.totalAmountToPay'); // Element to show the total amount to pay (including discount and shipping)

    if (totalPriceElement) {
        if (discounted) {
            totalPriceElement.innerHTML = `${storedCurrency} <span class="original-price">${totalPriceConverted}</span> <span class="pay-price">${storedCurrency} ${discountPriceConverted}</span>`;
        } else {
            totalPriceElement.innerText = `${storedCurrency} ${totalPriceConverted}`;
        }
    }

    if (discountElement) {
        if (discounted) {
            discountElement.innerHTML = `Save: ${storedCurrency} ${discountAmountConverted}`;
        } else {
            discountElement.innerHTML = ''; // Clear discount if no discount applied
        }
    }

    if (shippingElement) {
        // If shipping fee is removed (over ZAR 500), show "Shipping: ZAR 00.00"
        if (shippingFeeToApply === 0) {
            shippingElement.innerHTML = `Shipping fee: ${storedCurrency} 00.00`;
        } else {
            // Show the shipping fee normally
            shippingElement.innerHTML = `Shipping fee: ${storedCurrency} ${shippingFeeConverted}`;
        }
    }

    // Step 6: Calculate the total amount to pay (final price including discount and shipping)
    const totalAmountToPayZAR = discountPriceZAR + shippingFeeToApply;
    const totalAmountToPayConverted = convertPrice(totalAmountToPayZAR, storedCurrency);

    // Display the total amount to pay (including discount and shipping)
    if (totalAmountElement) {
        totalAmountElement.innerHTML = `Pay: ${storedCurrency} ${totalAmountToPayConverted}`;
    }

    // Step 7: Convert the discounted price to USD for PayPal (if discounted, use discountPriceZAR)
    const totalPriceInUSD = convertPrice(discountPriceZAR, 'USD'); // Always pass the discounted price to PayPal
    initPayPalButton(totalPriceInUSD, discounted, discountPriceZAR, shippingFeeToApply);  // Initialize PayPal button with USD amount, discount flag, and shipping fee
}

// Initialize PayPal button with total price in USD
function initPayPalButton(totalPriceInUSD, discounted, discountPriceZAR, shippingFeeZAR) {
    document.getElementById('paypal-button-container').innerHTML = '';  // Clear any previous PayPal button

    // If a discount is applied, use the discounted price; otherwise, use the original price
    const finalPriceInUSD = discounted ? totalPriceInUSD : convertPrice(discountPriceZAR, 'USD');  // Always use the discounted price if applicable

    // Calculate total price including shipping for PayPal (even if shipping is ZAR 00.00)
    const totalPriceWithShippingUSD = convertPrice(discountPriceZAR + shippingFeeZAR, 'USD'); // Add shipping fee in USD

    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                application_context: {
                    shipping_preference: "NO_SHIPPING"  // Use "NO_SHIPPING" to handle shipping fee separately
                },
                purchase_units: [{
                    amount: {
                        value: totalPriceWithShippingUSD  // Pass the final price including shipping fee to PayPal
                    }
                }]
            });
        },
        onApprove: async function(data, actions) {
            try {
                // Capture the payment
                const details = await actions.order.capture();  // Capture the payment

                // Payment successful
                alert("Payment successful! Thank you for your purchase.");

                const user = auth.currentUser;
                if (user) {
                    const userId = user.uid;
                    const cartId = generateCartId();  // Generate unique cartId
                    const timestamp = generateTimestamp(); // Generate timestamp

                    // Update payment status in Firebase
                    await updatePaymentStatus(userId, cartId, details, user.email); 
                }
            } catch (error) {
                // Payment failed or an error occurred
                console.error("Error processing payment:", error);

                alert("Payment failed! There was an error processing your payment. Please try again later.");
            }
        }
    }).render('#paypal-button-container');
}
    // Update payment status in Firebase
    async function updatePaymentStatus(userId, cartId, paymentDetails, userEmail) {
        const timestamp = generateTimestamp();  // Use timestamp for date/time

        const paymentRef = dbRef(db, 'payments/' + userId + '/' + cartId);  // Store payment using cartId
        
        // Fetch the user's profile data
        const profileRef = dbRef(db, 'profiles/' + userId);
        const profileSnapshot = await get(profileRef);
        
        let profileData = {};
        if (profileSnapshot.exists()) {
            profileData = profileSnapshot.val();  // If profile exists, get the profile data
        }

        await set(paymentRef, {
            status: 'completed',
            response: paymentDetails,
            email: userEmail,
            timestamp: timestamp,  // Use timestamp for date/time of payment
            cartId: cartId,  // Store cartId separately from the timestamp
            profile: profileData  // Include the profile data in the payment record
        });

        // Move cart to archived
        await moveCartToArchived(userId, cartId, timestamp, paymentDetails); // Pass cartId and timestamp
    }

    // Move cart to archived after payment
    async function moveCartToArchived(userId, cartId, timestamp, paymentDetails) {
        const cartRef = dbRef(db, 'carts/' + userId);
        const profileRef = dbRef(db, 'profiles/' + userId);

        const cartSnapshot = await get(cartRef);
        const profileSnapshot = await get(profileRef);

        if (cartSnapshot.exists() && profileSnapshot.exists()) {
            const cartItems = cartSnapshot.val().cart;
            const profileData = profileSnapshot.val();

            const archivedCartRef = dbRef(db, 'archivedCarts/' + userId + '/' + cartId);  // Use cartId
            await set(archivedCartRef, {
                status: 'completed',
                cart: cartItems,
                profile: profileData,
                timestamp: timestamp,  // Use timestamp for date/time
                paymentDetails: paymentDetails
            });

            // Optionally delete the cart or mark it as archived
            await update(dbRef(db, 'carts/' + userId), { cart: [] });
        }
    }
</script>
  <script src="js/main.js"></script>
</body>
</html>
